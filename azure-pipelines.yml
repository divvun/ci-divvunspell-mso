trigger:
- master

jobs:
- job: 'Windows'
  pool:
    vmImage: 'vs2017-win2016'
  steps:
  - task: InstallSSHKey@0
    inputs:
      hostName: gtsvn.uit.no,129.242.4.62 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAneiDKknQ2H37Zs9qyxko3HFDgPrelZKjWAsmSSdMbaFIqLDgJ1VrWemIVOBk2Otqg8GLgf98wU3KOaYGp9obRSVA7jNXSY/eGbfNIehFDJuMRpSfVAiMrcaEQPJICSzX+w3EfT+db7HVLyYtO1bAU7WrKezDZax22L3V4Pxb4QynUo5kagVfEx+C+sJ15nIyf62ADRpU8CoZPUoxeC4Sno4h2m4cThBk6RNOmcZ6XEjaft2nyWQc3G40oEzvfSJDPlbQ+mT9T7eOaE5KRwUXM4XqFr7eqsO8K7zlxlAZEEeqCQu34NkSzQTjYcD6rZrVaVnesreae9J9dwVhpOOnRw==
      sshPublicKey: $(sshKeyPublic)
      sshKeySecureFile: key.private
  - bash: |
      set -e
      git clone git@gtsvn.uit.no:divvunspell-mso
      curl -sLo LockedList.zip https://nsis.sourceforge.io/mediawiki/images/d/d3/LockedList.zip
      unzip LockedList.zip "Plugins/*" -d "C:\Program Files (x86)\NSIS" -q
      unzip LockedList.zip "Plugins/x86-ansi/*" -d "C:\Program Files (x86)\NSIS" -q
      unzip LockedList.zip "Plugins/x86-unicode/*" -d "C:\Program Files (x86)\NSIS" -q
      curl -sLo pahkat.exe https://github.com/divvun/pahkat/releases/download/0.6.0/pahkat.exe
      curl -sLo divvun-bundler.exe https://github.com/divvun/divvun-bundler/releases/download/0.1.0/divvun-bundler.exe
      curl -sLo win-reg-tool.exe https://github.com/fry/win-reg-tool/releases/download/0.1.3/win-reg-tool.exe
      curl -sLo rustup-init.exe https://win.rustup.rs/
      ./rustup-init.exe -y --default-host=i686-pc-windows-msvc --default-toolchain=nightly-i686-pc-windows-msvc
      git clone https://github.com/divvun/divvun-ci-config.git
      openssl aes-256-cbc -d -in ./divvun-ci-config/config.txz.enc -pass pass:$DIVVUN_KEY -out config.txz -md md5
      7z e config.txz
      tar xf config.tar
    displayName: 'Install prerequisites'
    env:
      DIVVUN_KEY: $(divvunKey)
  - script: |
      PATH=%PATH%;%USERPROFILE%\.cargo\bin
      cd divvunspell-mso
      call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvars32.bat"
      rustup default nightly-i686-pc-windows-msvc
      cargo build --target=i686-pc-windows-msvc --release
      call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
      rustup default nightly-x86_64-pc-windows-msvc
      cargo build --target=x86_64-pc-windows-msvc --release
    displayName: 'Build'
    env:
      SENTRY_DSN: https://a0b7a479b4094c4d96162e9bf0213095@sentry.io/1491750
  - powershell: |
      $Env:PATH += ";C:\Program Files (x86)\Microsoft SDKs\ClickOnce\SignTool"
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      cd divvunspell-mso
      $version = Select-String -Path .\Cargo.toml -Pattern "^version.*=.*$"
      $version = $version.Matches[0].Value.Replace('"', '').Replace(' ','').Replace('version=','')
      divvun-bundler -R -c ..\enc\creds\windows\divvun.pfx -V $version --uuid "{CE70EB42-1935-4B97-AED2-4113D929C485}" -H "Divvunspell MSOffice" -t win msoffice_checker --reg ..\win-reg-tool.exe  --a32 .\target\i686-pc-windows-msvc\release\divvunspellmso.dll --a64 .\target\x86_64-pc-windows-msvc\release\divvunspellmso.dll
      ls
      Move-Item divvunspell-mso-$version.exe ..\divvunspell-mso.exe
    displayName: 'Bundle'
    env:
      SIGN_PFX_PASSWORD: $(pfxPassword)
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(System.DefaultWorkingDirectory)/divvunspell-mso.exe'
      artifactName: windows
  - powershell: |
      . .\divvun-ci-config\repo\scripts\PahkatDeploySvn.ps1
      $Env:PATH += ";$(System.DefaultWorkingDirectory)"
      cd divvunspell-mso
      $version = Select-String -Path .\Cargo.toml -Pattern "^version.*=.*$"
      $version = $version.Matches[0].Value.Replace('"', '').Replace(' ','').Replace('version=','')
      PahkatDeploySvn -SvnUrl https://pahkat.uit.no/repo/windows -Artifact "$(System.DefaultWorkingDirectory)\divvunspell-mso.exe" -Package divvunspell-mso -Version $version
    displayName: 'Deploy to nightly channel'
    env:
      DEPLOY_SVN_USER: $(svnUser)
      DEPLOY_SVN_PASSWORD: $(svnPassword)
      DEPLOY_SVN_COMMIT: $(svnCommit)
  
